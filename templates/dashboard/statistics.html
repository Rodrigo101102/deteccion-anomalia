{% extends 'base.html' %}

{% block title %}Estadísticas - {{ block.super }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Gráfico de tendencias diarias -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-line"></i> Tendencia Últimos 7 Días</h5>
            </div>
            <div class="card-body">
                <canvas id="weeklyTrendChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Distribución de protocolos -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-pie"></i> Protocolos Más Comunes</h5>
            </div>
            <div class="card-body">
                <canvas id="protocolDistributionChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- Tabla de estadísticas por día -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> Estadísticas Detalladas</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Total</th>
                                <th>Normal</th>
                                <th>Anomalías</th>
                                <th>% Anomalías</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stat in stats_by_day %}
                            <tr>
                                <td>{{ stat.date }}</td>
                                <td>{{ stat.total }}</td>
                                <td>
                                    <span class="badge bg-success">{{ stat.normal }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-danger">{{ stat.anomalies }}</span>
                                </td>
                                <td>
                                    {% if stat.total > 0 %}
                                        {% widthratio stat.anomalies stat.total 100 %}%
                                    {% else %}
                                        0%
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center text-muted">
                                    No hay datos estadísticos disponibles
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Estadísticas de protocolos -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Top Protocolos</h5>
            </div>
            <div class="card-body">
                {% for protocol in protocol_stats %}
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span class="badge bg-info">{{ protocol.protocol }}</span>
                    <span class="fw-bold">{{ protocol.count }}</span>
                </div>
                {% empty %}
                <p class="text-muted">No hay datos de protocolos disponibles</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Resumen de métricas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Resumen de Rendimiento</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h3 class="text-primary">
                                {% for stat in stats_by_day %}{{ stat.total|add:0 }}{% endfor %}
                            </h3>
                            <p class="text-muted">Total Procesado (7 días)</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h3 class="text-success">
                                {% for stat in stats_by_day %}{{ stat.normal|add:0 }}{% endfor %}
                            </h3>
                            <p class="text-muted">Tráfico Normal</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h3 class="text-danger">
                                {% for stat in stats_by_day %}{{ stat.anomalies|add:0 }}{% endfor %}
                            </h3>
                            <p class="text-muted">Anomalías Detectadas</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <h3 class="text-info">
                                {% if stats_by_day %}
                                    {% with total=stats_by_day|length %}
                                        {{ total|floatformat:0 }}
                                    {% endwith %}
                                {% else %}
                                    0
                                {% endif %}
                            </h3>
                            <p class="text-muted">Días Analizados</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Weekly trend chart
const weeklyData = {
    labels: [{% for stat in stats_by_day %}'{{ stat.date }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
        label: 'Total',
        data: [{% for stat in stats_by_day %}{{ stat.total }}{% if not forloop.last %},{% endif %}{% endfor %}],
        borderColor: 'rgb(54, 162, 235)',
        backgroundColor: 'rgba(54, 162, 235, 0.1)',
        tension: 0.1
    }, {
        label: 'Anomalías',
        data: [{% for stat in stats_by_day %}{{ stat.anomalies }}{% if not forloop.last %},{% endif %}{% endfor %}],
        borderColor: 'rgb(255, 99, 132)',
        backgroundColor: 'rgba(255, 99, 132, 0.1)',
        tension: 0.1
    }]
};

const weeklyCtx = document.getElementById('weeklyTrendChart').getContext('2d');
new Chart(weeklyCtx, {
    type: 'line',
    data: weeklyData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            title: {
                display: true,
                text: 'Tendencia de Tráfico y Anomalías'
            }
        },
        scales: {
            y: {
                beginAtZero: true
            }
        }
    }
});

// Protocol distribution chart
const protocolData = {
    labels: [{% for protocol in protocol_stats %}'{{ protocol.protocol }}'{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
        data: [{% for protocol in protocol_stats %}{{ protocol.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
        backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#FF6384', '#C7C7C7', 
            '#4BC0C0', '#FF9F40'
        ]
    }]
};

const protocolCtx = document.getElementById('protocolDistributionChart').getContext('2d');
new Chart(protocolCtx, {
    type: 'doughnut',
    data: protocolData,
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
});
</script>
{% endblock %}