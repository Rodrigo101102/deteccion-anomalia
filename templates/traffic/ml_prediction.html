{% extends 'base.html' %}
{% load static %}

{% block title %}Predicciones ML - {{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.ml-card {
    border-left: 4px solid #007bff;
}
.model-status {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 8px;
    padding: 1.5rem;
}
.anomaly-indicator {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 8px;
}
.anomaly-high { background-color: #dc3545; }
.anomaly-medium { background-color: #ffc107; }
.anomaly-low { background-color: #28a745; }
.batch-selector {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-brain"></i> Predicciones Machine Learning</h1>
    <div>
        <a href="{% url 'traffic:pipeline' %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver al Pipeline
        </a>
    </div>
</div>

<!-- Estado del modelo -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card ml-card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-microchip"></i> Estado del Modelo ML</h5>
            </div>
            <div class="card-body">
                <div class="model-status">
                    <div class="row align-items-center">
                        <div class="col-md-3 text-center">
                            <i class="fas fa-robot fa-4x text-primary mb-2"></i>
                            <div>
                                <strong>Isolation Forest</strong>
                                <br><small class="text-muted">Modelo de Detección</small>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="h4 text-primary">{{ total_clasificados }}</div>
                                    <small class="text-muted">Total Clasificados</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 text-danger">{{ total_sin_procesar }}</div>
                                    <small class="text-muted">Sin Procesar</small>
                                </div>
                            </div>
                            
                            {% if total_clasificados > 0 %}
                                <div class="progress mt-3">
                                    <div class="progress-bar bg-success" style="width: {{ total_normales|div:total_clasificados|mul:100 }}%"></div>
                                    <div class="progress-bar bg-danger" style="width: {{ total_anomalias|div:total_clasificados|mul:100 }}%"></div>
                                </div>
                                <div class="d-flex justify-content-between mt-1">
                                    <small class="text-success">{{ total_normales }} Normales</small>
                                    <small class="text-danger">{{ total_anomalias }} Anomalías</small>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-3 text-center">
                            {% if porcentaje_anomalias <= 5 %}
                                <span class="anomaly-indicator anomaly-low"></span>
                                <strong class="text-success">Riesgo Bajo</strong>
                            {% elif porcentaje_anomalias <= 20 %}
                                <span class="anomaly-indicator anomaly-medium"></span>
                                <strong class="text-warning">Riesgo Medio</strong>
                            {% else %}
                                <span class="anomaly-indicator anomaly-high"></span>
                                <strong class="text-danger">Riesgo Alto</strong>
                            {% endif %}
                            <br>
                            <small class="text-muted">{{ porcentaje_anomalias|floatformat:1 }}% Anomalías</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Acciones ML -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-play-circle"></i> Ejecutar Predicciones</h6>
            </div>
            <div class="card-body">
                {% if total_sin_procesar > 0 %}
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>{{ total_sin_procesar }} registros</strong> están listos para ser procesados por el modelo ML.
                    </div>
                    
                    <div class="batch-selector mb-3">
                        <label class="form-label">
                            <i class="fas fa-layer-group"></i> Tamaño del Lote
                        </label>
                        <div class="row">
                            {% for batch_size in batch_sizes %}
                                <div class="col-md-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="batch_size" 
                                               id="batch{{ batch_size }}" value="{{ batch_size }}" 
                                               {% if batch_size == 1000 %}checked{% endif %}>
                                        <label class="form-check-label" for="batch{{ batch_size }}">
                                            {{ batch_size }}
                                        </label>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        <small class="text-muted">
                            Lotes más pequeños son más rápidos pero menos eficientes. 
                            Lotes grandes pueden tomar más tiempo pero procesan más datos de una vez.
                        </small>
                    </div>
                    
                    <div class="d-grid">
                        <button class="btn btn-primary btn-lg" onclick="ejecutarPredicciones()" id="predictBtn">
                            <i class="fas fa-brain"></i> Ejecutar Predicciones ML
                        </button>
                    </div>
                    
                    <div id="predictProgress" class="mt-3" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                 role="progressbar" style="width: 100%"></div>
                        </div>
                        <small class="text-muted">Ejecutando modelo de Machine Learning...</small>
                    </div>
                {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <h5 class="text-success">¡Todos los registros están procesados!</h5>
                        <p class="text-muted">No hay datos pendientes para clasificar.</p>
                        <p class="text-muted">Procesa más archivos CSV o realiza nuevas capturas para obtener más datos.</p>
                        
                        <div class="mt-3">
                            <a href="{% url 'traffic:csv_processing' %}" class="btn btn-outline-warning me-2">
                                <i class="fas fa-file-csv"></i> Procesar CSV
                            </a>
                            <a href="{% url 'traffic:capture_management' %}" class="btn btn-outline-success">
                                <i class="fas fa-play"></i> Nueva Captura
                            </a>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-cogs"></i> Gestión del Modelo</h6>
            </div>
            <div class="card-body">
                <p class="text-muted">
                    Entrena un nuevo modelo con los datos más recientes para mejorar la precisión.
                </p>
                
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="entrenarModelo()" id="trainBtn">
                        <i class="fas fa-graduation-cap"></i> Entrenar Modelo
                    </button>
                    
                    <button class="btn btn-outline-info" onclick="validarModelo()">
                        <i class="fas fa-check-double"></i> Validar Modelo
                    </button>
                    
                    <hr>
                    
                    <a href="{% url 'traffic:analytics' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-chart-line"></i> Ver Analíticas
                    </a>
                </div>
                
                <div id="trainProgress" class="mt-3" style="display: none;">
                    <div class="progress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated bg-warning" 
                             role="progressbar" style="width: 100%"></div>
                    </div>
                    <small class="text-muted">Entrenando modelo...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Resumen de resultados recientes -->
{% if total_clasificados > 0 %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Resumen de Clasificaciones</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <canvas id="anomalyChart" width="400" height="200"></canvas>
                    </div>
                    <div class="col-md-4">
                        <div class="row text-center">
                            <div class="col-12 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h4 class="text-success">{{ total_normales }}</h4>
                                        <small class="text-muted">Tráfico Normal</small>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-success" 
                                                 style="width: {{ total_normales|div:total_clasificados|mul:100 }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-12 mb-3">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h4 class="text-danger">{{ total_anomalias }}</h4>
                                        <small class="text-muted">Anomalías Detectadas</small>
                                        <div class="progress mt-2">
                                            <div class="progress-bar bg-danger" 
                                                 style="width: {{ total_anomalias|div:total_clasificados|mul:100 }}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="text-center">
                            <a href="{% url 'traffic:list' %}?label=ANOMALO" class="btn btn-outline-danger btn-sm">
                                <i class="fas fa-exclamation-triangle"></i> Ver Anomalías
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Modal de resultados -->
<div class="modal fade" id="resultsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Resultados del Procesamiento ML</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="resultsContent"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary" onclick="location.reload()">
                    <i class="fas fa-sync-alt"></i> Actualizar Página
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Gráfico de anomalías
{% if total_clasificados > 0 %}
$(document).ready(function() {
    const ctx = document.getElementById('anomalyChart').getContext('2d');
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Tráfico Normal', 'Anomalías'],
            datasets: [{
                data: [{{ total_normales }}, {{ total_anomalias }}],
                backgroundColor: ['#28a745', '#dc3545'],
                borderWidth: 2,
                borderColor: '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
});
{% endif %}

function ejecutarPredicciones() {
    const batchSize = $('input[name="batch_size"]:checked').val();
    const $btn = $('#predictBtn');
    const originalText = $btn.html();
    
    // Deshabilitar botón y mostrar progreso
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Procesando...');
    $('#predictProgress').show();
    
    $.ajax({
        url: '{% url "traffic:ml_prediction" %}',
        method: 'POST',
        data: {
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
            'action': 'predict',
            'batch_size': batchSize
        },
        success: function(response) {
            if (response.success) {
                mostrarResultadosML('Predicciones Completadas', {
                    registros_procesados: response.registros_procesados,
                    batch_size: batchSize
                });
                
                // Recargar página después de mostrar resultados
                setTimeout(function() {
                    location.reload();
                }, 3000);
            } else {
                showAlert('danger', response.error || 'Error ejecutando predicciones');
            }
        },
        error: function(xhr) {
            let errorMsg = 'Error de conexión';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            showAlert('danger', errorMsg);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalText);
            $('#predictProgress').hide();
        }
    });
}

function entrenarModelo() {
    const $btn = $('#trainBtn');
    const originalText = $btn.html();
    
    // Deshabilitar botón y mostrar progreso
    $btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Entrenando...');
    $('#trainProgress').show();
    
    $.ajax({
        url: '{% url "traffic:ml_prediction" %}',
        method: 'POST',
        data: {
            'csrfmiddlewaretoken': $('[name=csrfmiddlewaretoken]').val(),
            'action': 'train_model'
        },
        success: function(response) {
            if (response.success) {
                showAlert('success', response.message);
                
                // Recargar página después de 2 segundos
                setTimeout(function() {
                    location.reload();
                }, 2000);
            } else {
                showAlert('danger', response.error || 'Error entrenando modelo');
            }
        },
        error: function(xhr) {
            let errorMsg = 'Error de conexión';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMsg = xhr.responseJSON.error;
            }
            showAlert('danger', errorMsg);
        },
        complete: function() {
            $btn.prop('disabled', false).html(originalText);
            $('#trainProgress').hide();
        }
    });
}

function validarModelo() {
    showAlert('info', 'El modelo está funcionando correctamente. Basado en Isolation Forest para detección de anomalías.');
}

function mostrarResultadosML(titulo, resultado) {
    const html = `
        <div class="alert alert-success">
            <h6><i class="fas fa-check-circle"></i> ${titulo}</h6>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 class="text-primary">${resultado.registros_procesados || 0}</h4>
                        <small class="text-muted">Registros Procesados</small>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card bg-light">
                    <div class="card-body text-center">
                        <h4 class="text-info">${resultado.batch_size || 'N/A'}</h4>
                        <small class="text-muted">Tamaño de Lote</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3">
            <p class="text-muted">
                <i class="fas fa-info-circle"></i>
                Las predicciones están ahora disponibles para análisis. Los registros han sido clasificados como normales o anómalos.
            </p>
            <div class="d-flex gap-2">
                <a href="{% url 'traffic:list' %}?label=ANOMALO" class="btn btn-outline-danger btn-sm">
                    Ver Anomalías
                </a>
                <a href="{% url 'traffic:analytics' %}" class="btn btn-outline-info btn-sm">
                    Ver Analíticas
                </a>
            </div>
        </div>
    `;
    
    $('#resultsContent').html(html);
    $('#resultsModal').modal('show');
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('main .container-fluid').prepend(alertHtml);
    
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}
</script>

<!-- CSRF Token para AJAX -->
<script>
$(document).ready(function() {
    if (!$('[name=csrfmiddlewaretoken]').length) {
        $('body').append('<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">');
    }
});
</script>
{% endblock %}